<html><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><title>Composable State Space Models</title><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="description" content="Bayesian Inference for Composable State Space Models" /><meta name="author" content="com.github.jonnylaw" /><meta name="og:image" content="/ComposableStateSpaceModels/img/poster.png" /><meta name="og:title" content="Composable State Space Models" /><meta name="og:site_name" content="Composable State Space Models" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Bayesian Inference for Composable State Space Models" /><meta name="twitter:image" content="/ComposableStateSpaceModels/img/poster.png" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:site" content="" /><meta name="kazari-dependencies" content="" /><meta name="kazari-resolvers" content="" /><link rel="icon" type="image/png" href="/ComposableStateSpaceModels/img/favicon.png" /><link rel="icon" type="image/png" sizes="16x16" href="/ComposableStateSpaceModels/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/ComposableStateSpaceModels/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/ComposableStateSpaceModels/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/ComposableStateSpaceModels/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/ComposableStateSpaceModels/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/ComposableStateSpaceModels/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/ComposableStateSpaceModels/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/ComposableStateSpaceModels/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/ComposableStateSpaceModels/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/ComposableStateSpaceModels/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/ComposableStateSpaceModels/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/ComposableStateSpaceModels/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/ComposableStateSpaceModels/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/ComposableStateSpaceModels/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/ComposableStateSpaceModels/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/ComposableStateSpaceModels/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/ComposableStateSpaceModels/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/ComposableStateSpaceModels/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/ComposableStateSpaceModels/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/ComposableStateSpaceModels/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/ComposableStateSpaceModels/highlight/styles/solarized-dark.css" /><link rel="stylesheet" href="/ComposableStateSpaceModels/css/style.css" /><link rel="stylesheet" href="/ComposableStateSpaceModels/css/palette.css" /><link rel="stylesheet" href="/ComposableStateSpaceModels/css/codemirror.css" /><link rel="stylesheet" href="/ComposableStateSpaceModels/css/kazari-style.css" /><link rel="stylesheet" href="/ComposableStateSpaceModels/css/solarized-dark.css" /><link rel="stylesheet" href="/ComposableStateSpaceModels/css/solarized-dark.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/ComposableStateSpaceModels/" class="brand"><div class="brand-wrapper"><span>Composable State Space Models</span></div></a></li><li><a href="/ComposableStateSpaceModels/docs/forecasting.html" class="">Forecasting</a></li><li><a href="/ComposableStateSpaceModels/docs/" class="">Getting Started</a></li><li><a href="/ComposableStateSpaceModels/" class=""></a></li><li><a href="/ComposableStateSpaceModels/docs/model.html" class="">Models</a></li><li><a href="/ComposableStateSpaceModels/css/palette.css" class=""></a></li><li><a href="/ComposableStateSpaceModels/docs/particle_filter.html" class=" active ">Particle Filter</a></li><li><a href="/ComposableStateSpaceModels/docs/pmmh.html" class=""></a></li><li><a href="/ComposableStateSpaceModels/css/style.css" class=""></a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/jonnylaw/ComposableStateSpaceModels"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/jonnylaw/ComposableStateSpaceModels"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Composable State Space Models Bayesian Inference for Composable State Space Models');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Composable State Space Models Bayesian Inference for Composable State Space Models');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="jonnylaw" data-github-repo="ComposableStateSpaceModels"><div class="content-wrapper"><section><h1 id="determining-the-latent-state">Determining The Latent State</h1>

<p>Consider a simple state space model with a Gaussian Observation distribution and Brownian motion latent state, \(x(t)\):</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}
y(t_i) &= x(t_i) + v(t_i), \qquad v(t_i) \sim N(0, V(t_i)), \\
x(t_i) &= x(t_{i-1}) + w(t_i), \qquad w(t_i) \sim N(0, W(t_i)), \\
x(t_0) &\sim N(m(t_0), C(t_0))
\end{align} %]]></script>

<p>The true mean of the process at time \(t\), \(x(t)\) is obscured by measurement noise \(v(t)\). The goal of inference is to determine the true mean of the process, given the noisy measurements \(y(t)\).</p>

<p>In this case, the <a href="https://en.wikipedia.org/wiki/Kalman_filter">Kalman Filter</a> can be used to determine the posterior distribution of the state at time \(t\). This model is tractable, since the sum of two Gaussian distributions is Gaussian with the mean and variance added.</p>

<h2 id="particle-filter">Particle Filter</h2>

<p>The bootstrap particle filter can be used when the observation distribution or system evolution is not Gaussian, or the transformations involved are non-linear. First consider a general state-space model of the form,</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*}
Y(t_i)| x(t_i) &= \pi(Y(t_i) | x(t_i), \theta), \\
X(t_i)|x(t_{i-1}) &= p(X(t_i) | x(t_{i-1}), \theta)),\\
X(t_0) &\sim p(X(t_0) | \theta)
\end{align*} %]]></script>

<p>The observation distribution is denoted by \(\pi\) and has optional static parameters \(\theta\), representing the scale of the observation distribution which can be interpreted as the scale of the measurement noise. The latent-state has a Markov transition kernel which can be evaluated pointwise, denoted by \(p\), the evolution of the latent state has accompanying static parameters \(\theta\). The initial state is simulated from the initial state distribution, parameterised by \(\theta\).</p>

<p>Roughly speaking, the particle filter approximates the latent state with a particle cloud. Consider a parameterised model where the values of \(\theta\) are know, then the steps to implement the bootstrap particle filter are as follows:</p>

<ul>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Set \(i = 0\), Initialise the particle cloud by simulating N particles from the initial state distribution N times \(x(t_0)^{(k)} \sim p(x(t_0)^{(k)}</td>
          <td>\theta), k = 1,â€¦,N \)</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Advance the particle cloud to the time of the next observation \(x(t_{i+i})^{(k)} \sim p((x(t_i)^{(k)}</td>
          <td>x(t_{i-1})^{(k)}, \theta)), k=1,\dots,N\)</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Calculate the marginal likelihood of the observation at time \(t_i\), for each particle: \(w^\star(t_i)^{(k)} \sim \pi(y(t_i)</td>
          <td>x(t_i)^{(k)}, \theta), k=0,\dots,N\)</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>Normalise the weights \(w(t_i)^{(k)} = w^\star(t_i)^{(k)} / \sum_{j=1}^N w^\star(t_i)^{(j)}\)</li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Resample the particle using an appropriate resampling scheme, so that each particle is represented in the sample in proportion with the value of its associated weight. This gives an approximate sample from the filtering distribution, \(p(x(t_i)</td>
          <td>y(t_i))\).</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>If there are observations remaining, increment the value of \(i\) and go to step 2</li>
</ul>

<p>The value of interest is the filtering distribution, which is represented by a collection of particles at each time step. A statistic of interest is the mean of the filtering distribution, along with order statistics representing the uncertainty in estimating the filtering distribution. Increasing the number of particles in the filter will increase the accuracy of the estimate of the filtering distribution, at the cost of extra computation.</p>

<p>As an example of the particle filter, we will apply it to the Gaussian model presented above:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.github.jonnylaw.model._</span>
<span class="k">import</span> <span class="nn">akka.stream.scaladsl._</span>
<span class="k">import</span> <span class="nn">akka.stream._</span>
<span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>

<span class="k">val</span> <span class="n">sdeParameter</span> <span class="k">=</span> <span class="nc">SdeParameter</span><span class="o">.</span><span class="n">brownianParameter</span><span class="o">(</span><span class="n">m0</span> <span class="k">=</span> <span class="mf">1.0</span><span class="o">)(</span><span class="n">c0</span> <span class="k">=</span> <span class="mf">3.0</span><span class="o">)(</span><span class="n">sigma</span> <span class="k">=</span> <span class="mf">1.0</span><span class="o">)</span>
<span class="k">val</span> <span class="n">p</span> <span class="k">=</span> <span class="nc">Parameters</span><span class="o">.</span><span class="n">leafParameter</span><span class="o">(</span><span class="n">scale</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="mf">3.0</span><span class="o">),</span> <span class="n">sdeParameter</span><span class="o">)</span>
<span class="k">val</span> <span class="n">sde</span> <span class="k">=</span> <span class="nc">Sde</span><span class="o">.</span><span class="n">brownianMotion</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="k">val</span> <span class="n">model</span> <span class="k">=</span> <span class="nc">Model</span><span class="o">.</span><span class="n">linearModel</span><span class="o">(</span><span class="n">sde</span><span class="o">)</span>
</code></pre>
</div>

<p>This defines the parameters, the latent state and the observation model for the linear Gaussian Model. Now, we can simulate realisations from the model and use only the observations, \(y\) to estimate the filtering distribution \(x(t)\):</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="s">"SimulateToCSV"</span><span class="o">)</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">materializer</span> <span class="k">=</span> <span class="nc">ActorMaterializer</span><span class="o">()</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">executionContext</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">dispatcher</span>

<span class="k">val</span> <span class="n">data</span> <span class="k">=</span> <span class="nc">SimulateData</span><span class="o">(</span><span class="n">model</span><span class="o">(</span><span class="n">p</span><span class="o">)).</span>
  <span class="n">simRegular</span><span class="o">(</span><span class="mf">1.0</span><span class="o">).</span>
  <span class="n">take</span><span class="o">(</span><span class="mi">100</span><span class="o">).</span>
  <span class="n">map</span><span class="o">((</span><span class="n">d</span><span class="k">:</span> <span class="kt">Data</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">d</span><span class="o">.</span><span class="n">show</span><span class="o">).</span>
  <span class="n">runWith</span><span class="o">(</span><span class="nc">Streaming</span><span class="o">.</span><span class="n">writeStreamToFile</span><span class="o">(</span><span class="s">"data/gaussian_sims.csv"</span><span class="o">))</span>
</code></pre>
</div>

<p>Now we have 100 observations from a simple linear model:</p>

<p><img src="../img/GaussianSims.png" alt="A Simulation from the Linear Gaussian Model" width="750" /></p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">val</span> <span class="n">filter</span> <span class="k">=</span> <span class="nc">ParticleFilter</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="nc">Resampling</span><span class="o">.</span><span class="n">systematicResampling</span><span class="o">,</span> <span class="n">t0</span> <span class="k">=</span> <span class="mf">0.0</span><span class="o">,</span> <span class="mi">1000</span><span class="o">)</span> <span class="n">compose</span> <span class="n">model</span>
</code></pre>
</div>

<p>The filter is a function from a model to an Akka stream flow, once it is composed with a model it forms a <code class="highlighter-rouge">Flow[Data, PfState]</code>. This <code class="highlighter-rouge">Flow</code> is a reusable processing stage which transforms elements of type <code class="highlighter-rouge">Data</code> into elements of type <code class="highlighter-rouge">PfState</code> containing the particle approximation of the filtering distribution as well as the current pseudo-marginal likelihood (an estimate of the likelihood used in model fitting) of the parameters given the observed values. In this case, we will use the same parameters used to simulate the data, when filtering:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="nc">DataFromFile</span><span class="o">(</span><span class="s">"data/gaussian_sims.csv"</span><span class="o">).</span>
  <span class="n">observations</span><span class="o">.</span>
  <span class="n">via</span><span class="o">(</span><span class="n">filter</span><span class="o">(</span><span class="n">p</span><span class="o">)).</span>
  <span class="n">map</span><span class="o">(</span><span class="nc">ParticleFilter</span><span class="o">.</span><span class="n">getIntervals</span><span class="o">(</span><span class="n">model</span><span class="o">,</span> <span class="n">p</span><span class="o">)).</span>
  <span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">show</span><span class="o">).</span>
  <span class="n">runWith</span><span class="o">(</span><span class="nc">Streaming</span><span class="o">.</span><span class="n">writeStreamToFile</span><span class="o">(</span><span class="s">"data/gaussian_filtered.csv"</span><span class="o">)).</span>
  <span class="n">onComplete</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">system</span><span class="o">.</span><span class="n">terminate</span><span class="o">())</span>
</code></pre>
</div>

<p><img src="../img/GaussianFiltered.png" alt="Filtering the linear Gaussian Model" width="750" /></p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/ComposableStateSpaceModels/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="/ComposableStateSpaceModels/js/main.js"></script><script src="/ComposableStateSpaceModels/js/kazari.js"></script><script>
$(document).ready(function() {
	kazari.KazariPlugin().decorateCode('https://scala-evaluator-212.herokuapp.com/eval', 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.S2F6YXJp.Jl2eqMfw8IakJF93PjxTbrf-8YUJgX5OoOfy5JHE8Yw', '', 'solarized-dark')
})
    </script></body></html>